WCF.Todo={};WCF.Todo.Preview=WCF.Popover.extend({_proxy:null,_todoProfile:{},init:function(){this._super(".todoLink");this._proxy=new WCF.Action.Proxy({showLoadingOverlay:false})},_loadContent:function(){var a=$("#"+this._activeElementID);var d=a.data("todoID");if(this._todoProfile[d]){this._insertContent(this._activeElementID,this._todoProfile[d],true)}else{this._proxy.setOption("data",{actionName:"getToDoProfile",className:"wcf\\data\\todo\\ToDoAction",objectIDs:[d]});var c=this._activeElementID;var b=this;this._proxy.setOption("success",function(f,g,e){b._todoProfile[d]=f.returnValues.template;b._insertContent(c,f.returnValues.template,true)});this._proxy.setOption("failure",function(f,e,h,g){b._todoProfile[d]=f.message;b._insertContent(c,f.message,true);return false});this._proxy.sendRequest()}}});WCF.Todo.Like=WCF.Like.extend({_getContainers:function(){return $("article.message:not(.messageCollapsed)")},_getObjectID:function(a){return this._containers[a].data("todoID")},_getWidgetContainer:function(a){return this._containers[a].find(".messageHeader")},_buildWidget:function(b,a,e,d,f){var g=this._getWidgetContainer(b);if(this._canLike){var c=this._containers[b].find(".smallButtons");a.insertBefore(c.find(".toTopLink"));e.insertBefore(c.find(".toTopLink"));e.find("a").addClass("button");a.find("a").addClass("button")}if(f){f.appendTo(this._containers[b].find(".messageBody > .messageFooter"));f.addClass("messageFooterNote")}g.find(".permalink").after(d)},_setActiveState:function(a,b,c){a=a.find(".button").removeClass("active");b=b.find(".button").removeClass("active");if(c==1){a.addClass("active")}else{if(c==-1){b.addClass("active")}}},_addWidget:function(a,b){}});WCF.Todo.Like.Detail=WCF.Todo.Like.extend({_getContainers:function(){return $(".boxHeadline")},_buildWidget:function(b,a,e,d,f){var g=this._getWidgetContainer(b);if(this._canLike){var c=this._containers[b].find(".buttonGroup");a.insertBefore(c.find(".jsReportTodo"));e.insertBefore(c.find(".jsReportTodo"));e.find("a").addClass("button");a.find("a").addClass("button")}if(f){f.insertAfter(this._containers[b].find("p"))}this._containers[b].find("h1").append(" ").append(d)}});WCF.Todo.UpdateHandler=Class.extend({_todos:{},init:function(){var a=this;$(".jsTodo").each($.proxy(function(c,b){var d=$(b);a._todos[d.data("todoID")]=d},this))},update:function(c,d,b){if(!this._todos[c]){console.debug("[WCF.Todo.UpdateHandler] Unknown todo id "+c);return}for(var a in d){this._updateProperty(c,a,d[a])}if(b!==false){WCF.Clipboard.reload()}},_updateProperty:function(a,c,b){switch(c){case"isDisabled":if(b){this._disable(a)}else{this._enable(a)}break;case"deleted":this._delete(a,b);break;case"deleteNote":this._deleteNote(a,b);break;case"isDeleted":if(b){this._trash(a)}else{this._restore(a)}break;default:this._handleCustomProperty(a,c,b);break}WCF.Clipboard.reload()},_handleCustomProperty:function(a,c,b){this._todos[a].trigger("todoUpdateHandlerProperty",[a,c,b])},_enable:function(a){this._todos[a].data("isDisabled",0)},_disable:function(a){this._todos[a].data("isDisabled",1)},_trash:function(a){this._todos[a].data("isDeleted",1)},_delete:function(a,b){},_deleteNote:function(a,b){},_restore:function(a){this._todos[a].data("isDeleted",0)},getValue:function(a,b){if(!this._todos[a]){console.debug("[WCF.Todo.UpdateHandler] Unknown todo id "+a);return}switch(b){case"isDisabled":case"isDeleted":return this._todos[a].data(b);break}}});WCF.Todo.InlineEditor=WCF.InlineEditor.extend({_environment:"todo",_permissions:{},_updateHandler:null,_setOptions:function(){this._environment="todo";this._options=[{label:WCF.Language.get("wcf.todo.edit.enable"),optionName:"enable"},{label:WCF.Language.get("wcf.todo.edit.disable"),optionName:"disable"},{label:WCF.Language.get("wcf.todo.edit.trash"),optionName:"trash"},{label:WCF.Language.get("wcf.todo.edit.restore"),optionName:"restore"},{label:WCF.Language.get("wcf.todo.edit.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("wcf.todo.edit"),optionName:"edit",isQuickOption:true}]},setUpdateHandler:function(a){this._updateHandler=a},_getTriggerElement:function(a){return a.find(".jsTodoInlineEditor")},_show:function(b){var c=$(b.currentTarget).data("elementID");var a=null;if(!this._dropdowns[c]){a=this._getTriggerElement(this._elements[c]).addClass("dropdownToggle");var d=a.parent().addClass("dropdown");this._dropdowns[c]=$('<ul class="dropdownMenu" />').insertAfter(a);WCF.Dropdown.registerCallback(d.wcfIdentify(),$.proxy(function(e,f){WCF.Dropdown.getDropdown(e).parents(".messageOptions").toggleClass("forceOpen")},this))}this._super(b);if(a!==null){WCF.Dropdown.initDropdown(a,true)}return false},_validate:function(a,b){var c=$("#"+a).data("todoID");switch(b){case"enable":if(!this._getPermission("canEnableTodo")){return false}if(this._updateHandler.getValue(c,"isDeleted")){return false}return this._updateHandler.getValue(c,"isDisabled");break;case"disable":if(!this._getPermission("canEnableTodo")){return false}if(this._updateHandler.getValue(c,"isDeleted")){return false}return !this._updateHandler.getValue(c,"isDisabled");break;case"trash":if(!this._getPermission("canDeleteTodo")){return false}return !this._updateHandler.getValue(c,"isDeleted");break;case"delete":if(!this._getPermission("canDeleteTodoCompletely")){return false}return this._updateHandler.getValue(c,"isDeleted");break;case"restore":if(!this._getPermission("canRestoreTodo")){return false}return this._updateHandler.getValue(c,"isDeleted");break;case"edit":return(this._getPermission("canEditTodo"));break}return false},_execute:function(a,b){if(!this._validate(a,b)){return false}switch(b){case"enable":case"disable":this._updateTodo(a,b,{isDisabled:(b=="enable"?0:1)});break;case"delete":WCF.System.Confirmation.show(WCF.Language.get("wcf.todo.confirmDelete"),$.proxy(function(c){if(c=="confirm"){this._updateTodo(a,b,{deleted:1})}},this));break;case"restore":this._updateTodo(a,b,{isDeleted:0});break;case"trash":WCF.System.Confirmation.show(WCF.Language.get("wcf.todo.confirmTrash"),$.proxy(function(c){if(c=="confirm"){this._updateTodo(a,b,{isDeleted:1,reason:$("#wcfSystemConfirmationContent").find("textarea").val()})}},this),{},$("<fieldset><dl><dt>"+WCF.Language.get("wcf.todo.confirmTrash.reason")+'</dt><dd><textarea cols="40" rows="4" /></dd></dl></fieldset>'));break;case"edit":window.location=this._elements[a].data("editUrl");break;default:return false;break}return true},_updateTodo:function(a,b,c){var d=this._elements[a].data("todoID");if(b=="delete"){new WCF.Action.Proxy({autoSend:true,data:{actionName:"delete",className:"wcf\\data\\todo\\ToDoAction",objectIDs:[d]},success:$.proxy(function(e){this._updateHandler.update(d,e.returnValues.todoData[d])},this)})}else{this._updateData.push({data:c,elementID:a,optionName:b});this._proxy.setOption("data",{actionName:b,className:"wcf\\data\\todo\\ToDoAction",objectIDs:[this._elements[a].data("todoID")],parameters:{data:c}});this._proxy.sendRequest()}},_updateState:function(){this._notification.show();for(var d=0,c=this._updateData.length;d<c;d++){var a=this._updateData[d];var b=$("#"+a.elementID).data("todoID");this._updateHandler.update(b,a.data)}},_success:function(b,d,a){this._super(b,d,a);for(var c in b.returnValues.todoData){if(b.returnValues.todoData[c].deleteNote){this._updateHandler.update(c,b.returnValues.todoData[c])}}},setPermissions:function(a){for(var b in a){this._permissions[b]=a[b]}},_getPermission:function(a){if(this._permissions[a]){return this._permissions[a]}return 0},setEnvironment:function(a){if(a!="list"){a="todo"}this._environment=a}});WCF.Todo.UpdateHandler.List=WCF.Todo.UpdateHandler.extend({_enable:function(a){this._super(a);this._todos[a].removeClass("messageDisabled")},_disable:function(a){this._super(a);this._todos[a].addClass("messageDisabled")},_trash:function(a){this._super(a);this._todos[a].addClass("messageDeleted")},_delete:function(a,b){this._todos[a].remove();delete this._todos[a];WCF.Clipboard.reload()},_deleteNote:function(a,b){$('<p class="todoDeleteNote messageFooterNote">'+b+"</p>").appendTo(this._todos[a].find(".messageFooter"))},_restore:function(a){this._super(a);this._todos[a].removeClass("messageDeleted");this._todos[a].find(".messageFooter > .todoDeleteNote").remove()}});WCF.Todo.UpdateHandler.Todo=WCF.Todo.UpdateHandler.extend({_enable:function(a){this._super(a);$(".todoContainer").removeClass("todoDisabled");$(".sidebar").removeClass("disabled")},_disable:function(a){this._super(a);$(".sidebar").addClass("disabled")},_trash:function(a){this._super(a);$(".sidebar").addClass("deleted")},_delete:function(a,b){window.location=b},_deleteNote:function(a,b){$('<fieldset class="todoDeleteNote"><small>'+b+"</small></fieldset>").appendTo($(".sidebar > div"))},_restore:function(a){this._super(a);$(".todoContainer").removeClass("todoDeleted");$(".sidebar").removeClass("deleted");$(".sidebar > div > .todoDeleteNote").remove()}});WCF.Todo.Clipboard=Class.extend({_updateHandler:null,init:function(updateHandler){this._updateHandler=updateHandler;$(".jsClipboardEditor").each($.proxy(function(index,container){var $container=$(container);var $types=eval($container.data("types"));if(WCF.inArray("de.mysterycode.wcf.toDo.toDo",$types)){$container.on("clipboardAction",$.proxy(this._execute,this));$container.on("clipboardActionResponse",$.proxy(this._evaluateResponse,this));return false}},this))},_execute:function(d,b,a,c){if(b!=="de.mysterycode.wcf.toDo.toDo"){return}switch(a){case"de.mysterycode.wcf.toDo.toDo.trash":WCF.System.Confirmation.show(WCF.Language.get("wcf.todo.confirmTrash"),$.proxy(this._trash,this,c),{},$("<fieldset><dl><dt>"+WCF.Language.get("wcf.todo.confirmTrash.reason")+'</dt><dd><textarea cols="40" rows="4" /></dd></dl></fieldset>'));break}},_trash:function(b,c){if(c=="confirm"){var a=$("#wcfSystemConfirmationContent").find("textarea").val();new WCF.Action.Proxy({autoSend:true,data:{actionName:"trash",className:"wcf\\data\\todo\\ToDoAction",objectIDs:b.objectIDs,parameters:{data:{reason:a}}},success:$.proxy(function(e,f,d){this._evaluateResponse(null,e,"de.mysterycode.wcf.toDo.toDo","de.mysterycode.wcf.toDo.toDo.trash",null)},this)})}},_evaluateResponse:function(d,e,b,a,c){if(b!=="de.mysterycode.wcf.toDo.toDo"){return}if(!e.returnValues.todoData||!$.getLength(e.returnValues.todoData)){return}for(var f in e.returnValues.todoData){this._updateHandler.update(f,e.returnValues.todoData[f])}}});WCF.Todo.Participate=Class.extend({_buttons:{},_buttonSelector:"",_dialog:null,_notification:null,_objectID:0,_userID:0,_proxy:null,init:function(a){this._buttonSelector=a;this._buttons={};this._notification=null;this._objectID=0;this._userID=0;this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});this._initButtons();WCF.DOMNodeInsertedHandler.addCallback("WCF.Todo.Participate",$.proxy(this._initButtons,this))},_initButtons:function(){var a=this;$(this._buttonSelector).each(function(c,d){var e=$(d);var b=e.wcfIdentify();if(!a._buttons[b]){a._buttons[b]=e;e.click($.proxy(a._click,a))}})},_click:function(a){this._objectID=$(a.currentTarget).data("objectID");this._userID=$(a.currentTarget).data("userID");this._showDialog();this._dialog.find(".jsSubmitParticipate").click($.proxy(this._submit,this))},_success:function(b,c,a){if(b.returnValues.submitted){if(this._notification===null){this._notification=new WCF.System.Notification(WCF.Language.get("wcf.toDo.task.participate.success"))}this._dialog.wcfDialog("close");this._notification.show();setTimeout(function(){location.reload()},1000)}},_showDialog:function(){if(this._dialog===null){this._dialog=$("#participateDialog");if(!this._dialog.length){this._dialog=$('<div id="participateDialog" />').hide().appendTo(document.body)}}var a=WCF.Language.get("wcf.toDo.task.participate.shure")+'<div class="formSubmit"><button class="jsSubmitParticipate buttonPrimary" accesskey="s" autofocus>'+WCF.Language.get("wcf.global.button.submit")+"</button></div>";this._dialog.html(a).wcfDialog({title:WCF.Language.get("wcf.toDo.task.participate")}).wcfDialog("render")},_submit:function(){this._proxy.setOption("data",{actionName:"participate",className:"wcf\\data\\todo\\ToDoAction",parameters:{userID:this._userID,objectID:this._objectID}});this._proxy.sendRequest()}});WCF.Todo.MarkSolved=Class.extend({_buttons:{},_buttonSelector:"",_dialog:null,_notification:null,_objectID:0,_userID:0,_proxy:null,init:function(a){this._buttonSelector=a;this._buttons={};this._notification=null;this._objectID=0;this._userID=0;this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});this._initButtons();WCF.DOMNodeInsertedHandler.addCallback("WCF.Todo.MarkSolved",$.proxy(this._initButtons,this))},_initButtons:function(){var a=this;$(this._buttonSelector).each(function(c,d){var e=$(d);var b=e.wcfIdentify();if(!a._buttons[b]){a._buttons[b]=e;e.click($.proxy(a._click,a))}})},_click:function(a){this._objectID=$(a.currentTarget).data("objectID");this._userID=$(a.currentTarget).data("userID");this._showDialog();this._dialog.find(".jsSubmitMarkSolved").click($.proxy(this._submit,this))},_success:function(b,c,a){if(b.returnValues.success){if(this._notification===null){this._notification=new WCF.System.Notification(WCF.Language.get("wcf.toDo.task.solve.success"))}this._dialog.wcfDialog("close");this._notification.show();setTimeout(function(){location.reload()},1000)}},_showDialog:function(){if(this._dialog===null){this._dialog=$("#markSolvedDialog");if(!this._dialog.length){this._dialog=$('<div id="markSolvedDialog" />').hide().appendTo(document.body)}}var a=WCF.Language.get("wcf.toDo.task.solve.shure")+'<div class="formSubmit"><button class="jsSubmitMarkSolved buttonPrimary" accesskey="s" autofocus>'+WCF.Language.get("wcf.global.button.submit")+"</button></div>";this._dialog.html(a).wcfDialog({title:WCF.Language.get("wcf.toDo.task.solve")}).wcfDialog("render")},_submit:function(){this._proxy.setOption("data",{actionName:"editStatus",className:"wcf\\data\\todo\\ToDoAction",parameters:{userID:this._userID,objectID:this._objectID,status:1}});this._proxy.sendRequest()}});WCF.Todo.QuoteHandler=WCF.Message.Quote.Handler.extend({init:function(a){this._super(a,"wcf\\data\\todo\\ToDoAction","de.mysterycode.wcf.toDo",".todoQuoteContainer",".todoDescription",".todoDescription > fieldset > div",false)}});WCF.Todo.UpdateProgress=Class.extend({_callback:null,_dialog:null,_proxy:null,_className:"wcf\\data\\todo\\ToDoAction",_languageItemPrefix:"wcf.toDo",_didInit:false,_objectID:0,init:function(a){this._dialog=$("<div />").hide().appendTo(document.body);this._proxy=new WCF.Action.Proxy();this._objectID=a;if(!this._didInit){this._init()}this._didInit=true},_init:function(){$(".updateProgress").click($.proxy(this.prepare,this))},prepare:function(a){this._proxy.setOption("data",{actionName:"prepareProgressUpdate",className:this._className,objectIDs:[this._objectID]});this._proxy.setOption("success",$.proxy(this._success,this));this._proxy.sendRequest()},_success:function(b,c,a){this._dialog.data("objectID",b.objectIDs[0]).html(b.returnValues.template);this._dialog.wcfDialog({title:WCF.Language.get("wcf.toDo.task.progress.update")});this._dialog.find(".formSubmit > input[type=submit]").click($.proxy(this._submit,this))},_submit:function(b){var a=this._getParameters();if(Object.keys(a).length){this._proxy.setOption("data",{actionName:"progressUpdate",className:this._className,objectIDs:[this._objectID],parameters:a});this._proxy.setOption("success",$.proxy(function(c){this._callback(c)},this));this._proxy.sendRequest();this._dialog.wcfDialog("close")}},_callback:function(a){$(".progressbar_inner").width("calc(100% - "+a.returnValues.progress+"% + 2px)");$(".progressbar_text").html(a.returnValues.progress+" "+WCF.Language.get("wcf.toDo.task.progress.percent"))},_getParameters:function(){return{progress:$("#progress").val()}},_showInlineError:function(b,c,d){var a=this._languageItemPrefix+"."+c+".error."+d;if(d=="empty"){a="wcf.global.form.error.empty"}$(b).parent().append($('<small class="innerError">'+WCF.Language.get(a)+"</small>"))}});WCF.Todo.Search={};WCF.Todo.Search.User=WCF.Search.Base.extend({_className:"wcf\\data\\user\\group\\UserGroupSearchAction",init:function(b,d,a,c){this._super(b,d,a,c)},_createListItem:function(e){var d=this._super(e);var b=null;if(e.icon){b=$(e.icon)}else{if(e.type==="group"){b=$('<span class="icon icon16 icon-group" />')}}if(b){var a=d.find("span").detach();var c=$("<div />").addClass("box16").appendTo(d);c.append(b);c.append($("<div />").append(a))}d.data("type",e.type);return d}});