WCF.Todo={},WCF.Todo.UpdateHandler=Class.extend({_todos:{},init:function(){$(".todo").each($.proxy(function(e,t){var o=$(t);this._todos[o.data("todoID")]=o},this))},update:function(e,t){if(this._todos[e])for(var o in t)this._updateProperty(e,o,t[o])},_updateProperty:function(e,t,o){switch(t){case"isDisabled":o?this._disable(e):this._enable(e);break;case"deleted":this._delete(e,o);break;case"deleteNote":this._deleteNote(e,o);break;case"isDeleted":o?this._trash(e):this._restore(e);break;default:this._handleCustomProperty(e,t,o)}WCF.Clipboard.reload()},_handleCustomProperty:function(e,t,o){this._todos[e].trigger("todoUpdateHandlerProperty",[e,t,o])},_enable:function(e){this._todos[e].data("isDisabled",0)},_disable:function(e){this._todos[e].data("isDisabled",1)},_trash:function(e){this._todos[e].data("isDeleted",1)},_delete:function(){},_deleteNote:function(){},_restore:function(e){this._todos[e].data("isDeleted",0)},getValue:function(e,t){if(!this._todos[e])return void console.debug("[WCF.Todo.UpdateHandler] Unknown todo id "+e);switch(t){case"isDisabled":case"isDeleted":return this._todos[e].data(t)}}}),WCF.Todo.InlineEditor=WCF.InlineEditor.extend({_environment:"todo",_permissions:{},_updateHandler:null,_setOptions:function(){this._environment="todo",this._options=[{label:WCF.Language.get("wcf.todo.edit.enable"),optionName:"enable"},{label:WCF.Language.get("wcf.todo.edit.disable"),optionName:"disable"},{label:WCF.Language.get("wcf.todo.edit.trash"),optionName:"trash"},{label:WCF.Language.get("wcf.todo.restore"),optionName:"restore"},{label:WCF.Language.get("wcf.todo.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("wcf.todo.edit"),optionName:"edit",isQuickOption:!0}]},setUpdateHandler:function(e){this._updateHandler=e},_getTriggerElement:function(e){return e.find(".jsTodoInlineEditor")},_show:function(e){var t=$(e.currentTarget).data("elementID"),o=null;if(!this._dropdowns[t]){o=this._getTriggerElement(this._elements[t]).addClass("dropdownToggle");var a=o.parent().addClass("dropdown");this._dropdowns[t]=$('<ul class="dropdownMenu" />').insertAfter(o),WCF.Dropdown.registerCallback(a.wcfIdentify(),$.proxy(function(e){WCF.Dropdown.getDropdown(e).parents(".messageOptions").toggleClass("forceOpen")},this))}return this._super(e),null!==o&&WCF.Dropdown.initDropdown(o,!0),!1},_validate:function(e,t){var o=$("#"+e).data("todoID");switch(t){case"enable":return this._getPermission("canEnableTodo")?this._updateHandler.getValue(o,"isDeleted")?!1:this._updateHandler.getValue(o,"isDisabled")?!0:!1:!1;case"disable":return this._getPermission("canEnableTodo")?this._updateHandler.getValue(o,"isDeleted")?!1:this._updateHandler.getValue(o,"isDisabled")?!1:!0:!1;case"trash":return this._getPermission("canDeleteTodo")?this._updateHandler.getValue(o,"isDeleted")?!1:!0:!1;case"delete":return this._getPermission("canDeleteTodoCompletely")?this._updateHandler.getValue(o,"isDeleted")?!0:!1:!1;case"restore":return this._getPermission("canRestoreTodo")?this._updateHandler.getValue(o,"isDeleted")?!0:!1:!1;case"edit":return this._elements[e].data("canEdit")}return!1},_execute:function(e,t){if(!this._validate(e,t))return!1;switch(t){case"enable":case"disable":this._updateTodo(e,t,{isDisabled:"enable"==t?0:1});break;case"delete":WCF.System.Confirmation.show(WCF.Language.get("wcf.todo.confirmDelete"),$.proxy(function(o){"confirm"==o&&this._updateTodo(e,t,{deleted:1})},this));break;case"restore":this._updateTodo(e,t,{isDeleted:0});break;case"trash":WCF.System.Confirmation.show(WCF.Language.get("wcf.todo.confirmTrash"),$.proxy(function(o){"confirm"==o&&this._updateTodo(e,t,{isDeleted:1,reason:$("#wcfSystemConfirmationContent").find("textarea").val()})},this),{},$("<fieldset><dl><dt>"+WCF.Language.get("wcf.todo.confirmTrash.reason")+'</dt><dd><textarea cols="40" rows="4" /></dd></dl></fieldset>'));break;case"edit":window.location=this._elements[e].data("editUrl");break;default:return!1}return!0},_updateTodo:function(e,t,o){var a=this._elements[e].data("todoID");"delete"==t?new WCF.Action.Proxy({autoSend:!0,data:{actionName:"delete",className:"wcf\\data\\todo\\ToDoAction",objectIDs:[a]},success:$.proxy(function(e){this._updateHandler.update(a,e.returnValues.todoData[a])},this)}):(this._updateData.push({data:o,elementID:e,optionName:t}),this._proxy.setOption("data",{actionName:t,className:"wcf\\data\\todo\\ToDoAction",objectIDs:[this._elements[e].data("todoID")],parameters:{data:o}}),this._proxy.sendRequest())},_updateState:function(){this._notification.show();for(var e=0,t=this._updateData.length;t>e;e++){var o=this._updateData[e],a=$("#"+o.elementID).data("todoID");this._updateHandler.update(a,o.data)}},_success:function(e,t,o){this._super(e,t,o);for(var a in e.returnValues.todoData)e.returnValues.todoData[a].deleteNote&&this._updateHandler.update(a,e.returnValues.todoyData[a])},setPermissions:function(e){for(var t in e)this._permissions[t]=e[t]},_getPermission:function(e){return this._permissions[e]?this._permissions[e]:0},setEnvironment:function(e){"list"!=e&&(e="todo"),this._environment=e}}),WCF.Todo.UpdateHandler.List=WCF.Todo.UpdateHandler.extend({_enable:function(e){this._super(e),this._todos[e].removeClass("messageDisabled")},_disable:function(e){this._super(e),this._todos[e].addClass("messageDisabled")},_trash:function(e){this._super(e),this._todos[e].addClass("messageDeleted")},_delete:function(e){this._todos[e].remove(),delete this._todos[e]},_deleteNote:function(e,t){$('<p class="todoDeleteNote messageFooterNote">'+t+"</p>").appendTo(this._todos[e].find(".messageFooter"))},_restore:function(e){this._super(e),this._todos[e].removeClass("messageDeleted"),this._todos[e].find(".messageFooter > .todoDeleteNote").remove()}}),WCF.Todo.UpdateHandler.Todo=WCF.Todo.UpdateHandler.extend({_enable:function(e){this._super(e),$(".sidebar").removeClass("disabled")},_disable:function(e){this._super(e),$(".sidebar").addClass("disabled")},_trash:function(e){this._super(e),$(".sidebar").addClass("deleted")},_delete:function(e,t){window.location=t},_deleteNote:function(e,t){$('<fieldset class="todoDeleteNote"><small>'+t+"</small></fieldset>").appendTo($(".sidebar > div"))},_restore:function(e){this._super(e),$(".sidebar").removeClass("deleted"),$(".sidebar > div > .todoDeleteNote").remove()}}),WCF.Todo.Clipboard=Class.extend({_updateHandler:null,init:function(updateHandler){this._updateHandler=updateHandler,$(".jsClipboardEditor").each($.proxy(function(index,container){var $container=$(container),$types=eval($container.data("types"));return WCF.inArray("de.mysterycode.wcf.toDo.toDo",$types)?($container.on("clipboardAction",$.proxy(this._execute,this)),$container.on("clipboardActionResponse",$.proxy(this._evaluateResponse,this)),!1):void 0},this))},_execute:function(e,t,o,a){if("de.mysterycode.wcf.toDo.toDo"===t)switch(o){case"de.mysterycode.wcf.toDo.toDo.trash":WCF.System.Confirmation.show(WCF.Language.get("wcf.todo.confirmTrash"),$.proxy(this._trash,this,a),{},$("<fieldset><dl><dt>"+WCF.Language.get("wcf.todo.confirmTrash.reason")+'</dt><dd><textarea cols="40" rows="4" /></dd></dl></fieldset>'))}},_trash:function(e,t){if("confirm"==t){var o=$("#wcfSystemConfirmationContent").find("textarea").val();new WCF.Action.Proxy({autoSend:!0,data:{actionName:"trash",className:"wcf\\data\\todo\\ToDoAction",objectIDs:e.objectIDs,parameters:{data:{reason:o}}},success:$.proxy(function(e){this._evaluateResponse(null,e,"de.mysterycode.wcf.toDo.toDo","de.mysterycode.wcf.toDo.toDo.trash",null)},this)})}},_evaluateResponse:function(e,t,o){if("de.mysterycode.wcf.toDo.toDo"===o&&t.returnValues.todoData&&$.getLength(t.returnValues.todoData))for(var a in t.returnValues.todoData)this._updateHandler.update(a,t.returnValues.todoData[a])}});